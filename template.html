<!DOCTYPE html>
<html>
<head>

<link type="text/css" rel="stylesheet" href="styles.css"

<!-- StackMob JS SDK Javascript Dependencies -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/json2-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/underscore-1.3.0-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/backbone-0.5.3-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.2.1-min.js"></script>
 
<!-- Initialize the StackMob JS SDK -->
<script type="text/javascript">
  StackMob.init({
    appName: "myfirstapp",
    clientSubdomain: "bjhomer",
    apiVersion: 0
  });
</script>

</head>
<body>


<h1>Simple Template</h1>

<p>This is an empty HTML file that has the JS libraries included so that you can get started!  View source and edit to start!</p>


<input id='file-picker' type="file" multiple onchange="listFiles(this.files)"/>

<input class="button green" type="button" onclick="uploadFiles()" value="Upload!" />
<div></div>
<ul id="selected-files"></ul>

<!-- 
This is a simple template so that you can get started.  
It has all the JS libraries included for you already.  
You can also choose to use Zepto.js or Sencha's ExtJS in place of jQuery.  Simply replace the jQuery include.
-->

<script type="text/javascript">
/* Your code can go here */

var Version = StackMob.Model.extend({
    schemaName: 'version'
});


function listFiles(files) {
  $('#selected-files').html('');
  for (var i = 0, numFiles = files.length; i < numFiles; i++) {
    var file = files[i];
    file.index = i;
    $('#selected-files').append('<li>' + file.name + '<span class="status" id="status-'+i+'"></span></li>');
  }
}

function uploadFiles() {
  var files = $('#file-picker')[0].files;
  for (var i = 0, numFiles = files.length; i < numFiles; i++) {
    var file = files[i];
    uploadFile(file);
  }
}

function uploadFile(file) {
  var reader = new FileReader();  
  var versionInstance = new Version();
  
  $('#status-'+file.index).html('uploading').addClass('inprogress')
  
  stackmobDataForFile(file, function(the_data) {
    var fileIndex = file.index;
    versionInstance.set({'binary_data': the_data});
    var retVal = versionInstance.create({
      success: function(model) {
        console.debug("upload succeeded");
        $('#status-'+fileIndex).html("done").removeClass('inprogress').addClass('done');
      },
      error: function(model, response) {
        console.debug("upload failed: " + response);
        $('#status-'+fileIndex).html("error").removeClass('inprogress');
      }    });
  });
}

function stackmobDataForFile(file, handler) {
  var type = file.type
  var name = file.name
  var reader = new FileReader()
  
  reader.onload = function(e) {
    var fileData = e.target.result.substring(e.target.result.indexOf(',') + 1, e.target.result.length);
	var str = "Content-Type: "+ type + "\n" +
	  "Content-Disposition: attachment; filename="+name+"\n" +
	  "Content-Transfer-Encoding: base64\n\n"+fileData
	
	handler(str)
  }
  reader.readAsDataURL(file)
}
</script>


</body>
</html>