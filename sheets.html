<!DOCTYPE html>
<html>
<head>

<link type="text/css" rel="stylesheet" href="styles.css"

<!-- StackMob JS SDK Javascript Dependencies -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/json2-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/underscore-1.3.3-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.2.1.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/backbone-0.9.2-min.js"></script>
<script type="text/javascript" src="jquery.csv.js"></script>

<!-- Initialize the StackMob JS SDK -->
<script type="text/javascript">
  StackMob.init({
    appName: "myfirstapp",
    clientSubdomain: "bjhomer",
    apiVersion: 0
  });
</script>

</head>
<body>

<div id="loginStatus"></div>

<div id="login-body" style="display:none">
  <div id="csv-drop" class="drag-target">Drop a CSV here</div>
  <div></div>

  <div id="pdf-drop" class="drag-target green">Drop PDFs here
    <ul id="sheetgroups-list">
    </ul>
  </div>
  <div></div>
  <input type="button" onclick="uploadFiles()" value="Upload files" />

<!-- Templates for cloning -->

  <li id="sheetgroup-template" style="display:none">
    <span class="sheetgroup-name"></span>
    <div></div>
    <ul class="sheets-list">
    </ul>
  </li>
<!-- End templates for cloning -->

</div>

<script type="text/javascript">

String.prototype.endsWith = function(suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

var SheetGroup = StackMob.Model.extend({ schemaName: 'sheetgroup' });
var SheetGroupsCollection = StackMob.Collection.extend({ model: SheetGroup });
var sheetgroups = new SheetGroupsCollection();

var Sheet = StackMob.Model.extend({ 
  schemaName: 'sheet',
  readFile: function sheetFromFile(file, handler) {
    var reader = new FileReader();  

    this.set({title: file.name});
    var thisSheet = this;

    reader.onload = function (e) {
      var base64Content = e.target.result.substring(e.target.result.indexOf(',') + 1, e.target.result.length);
      var fileName = file.name;
      var fileType = file.type;

      thisSheet.setBinaryFile('sheet_data', fileName, fileType, base64Content);

      handler(thisSheet);
    };
    reader.readAsDataURL(file);
  }
});
var SheetCollection = StackMob.Collection.extend({model: Sheet});

var Project = StackMob.Model.extend({ schemaName: 'project' });

var loginStatus = document.getElementById('loginStatus');

var projectId = window.location.search.substring(1)
var project = new Project({ project_id: projectId });

var expectedStructure = [];

function populateSheetGroups() {
  var loggedIn = StackMob.isLoggedIn();
  if (loggedIn == false) {
    console.debug("Can't list sheets while not logged in");
    return;
  }
  
  
  project.fetchExpanded(2, {
    success: function(model) {
      project = model;
      var groups = project.get('sheetgroups') || [];
      for (var i=0; i<groups.length; ++i) {
        var model = new SheetGroup(groups[i]);
        sheetgroups.add(model);
        expectedStructure.push(groups[i])
      }
      renderExpectedStructure();
    },
    failure: function(model, response) {
      console.debug('failed to fetch project: ' + response);
    }
  });

}

function renderSheetGroup(group) {
  var name = group.name;
  var idName = name.replace(/ /g, '');
  var $newElement = $('#sheetgroup-template').clone();
  $newElement.attr('id', 'sheetgroup-'+idName);
  $newElement.find('.sheetgroup-name').text(name);
  $newElement.css('display', '')

  $('#sheetgroups-list').append($newElement);

  var sheets = group.sheets || [];
  var $sheetsList = $newElement.find('.sheets-list');
  for (var i=0; i<sheets.length; ++i) {
    var sheet = sheets[i];
    $sheetsList.append('<li>' + sheet.title + '</li>');
  }
}

function renderExpectedStructure () {
  $('#sheetgroups-list').html('');
  for (var i=0; i<expectedStructure.length; ++i) {
    var group = expectedStructure[i];
    renderSheetGroup(group);
  }
}

function createNewSheetGroup(name) {
  if (name.length == 0) {
    return;
  }
  var group = new SheetGroup({name: name});
  project.addRelationship('sheetgroups', [group], {
    success: function (group) {
      if (!group.toJSON) {
        group = new SheetGroup(group); 
      }
      expectedStructure.push(group.toJSON());
      sheetgroups.add(group);
      renderSheetGroup(group.toJSON());
    },
    error: function (model, response) {
      console.debug(response);
    }
  });
}

function checkForLogin() {
  var loggedIn = StackMob.isLoggedIn();
  if (loggedIn == false) {
    $(loginStatus).html('<span>You are not logged in.<span> <a href="/login.html">Log in.</a>');
  }
  else {
    var username = StackMob.getLoggedInUser();
    $(loginStatus).text('Welcome, ' + username);
    $('#login-body').css('display', '')
  }
}

function insertFilesInGroup(files, group) {
  var groupname = group.get('name').replace(/ /g, '');
  var dropzone = $('#drag-target-' + groupname);
  var listElement = $(dropzone).find('ul.selected-files')
  if (group.pendingSheets == undefined) {
    group.pendingSheets = new SheetCollection();
  }

  for (var i=0; i<files.length; ++i) {
    var file = files[i];

    var sheet = new Sheet();
    $(listElement).append('<li>' + file.name + '<span class="status" id="status-'+sheet.cid+'"></span></li>');
  
    sheet.readFile(file, function (sheet) {
      group.pendingSheets.add(sheet);
    });
  }
}

function uploadFiles() {
  if (StackMob.isLoggedIn() == false) {
    return;
  }
  sheetgroups.each(function(group) {
    var sheets = group.pendingSheets || new SheetCollection();
    sheets.each(function(sheet) {
      uploadSheetToGroup(sheet, group)
    });
  });
}



function uploadSheetToGroup(sheet, group) {

  $('#status-'+sheet.cid).html('uploading').addClass('inprogress')
  sheet.create({
    error: function (model, response) {
      console.debug('save failed:' + response);
    },
    success: function(model) {

      group.appendAndSave('sheets', [model.get('sheet_id')], {

        success: function(model) {
          console.debug("upload succeeded");
          $('#status-'+sheet.cid).html("done").removeClass('inprogress').addClass('done');
        },
        error: function(model, response) {
          console.debug("upload failed: " + response);
          $('#status-'+sheet.cid).html("error").removeClass('inprogress');
        }
        
      })
    }
  })
}

function setupDragAndDrop(dropzone, dropHandler) {

  dropzone.ondragenter = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    $(dropzone).addClass('highlighted');
  }
  
  dropzone.ondragleave = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    $(dropzone).removeClass('highlighted');
  }
  
  dropzone.ondragover = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    event.dataTransfer.dropEffect = 'copy'
  }
  
  dropzone.ondrop = function(event) {
    event.stopPropagation();
    event.preventDefault();

    $(dropzone).removeClass('highlighted')

    dropHandler(event, dropzone)
  }
}

function handlePDFDrops (event, dropzone) {
  var group = $(dropzone).data('sheetgroup');
  var sheetnames = {};

  var sheets = group.get('sheets');
  if (sheets != undefined) {
    for (var i=0; i<sheets.length; ++i) {
      var sheetInfo = sheets[i];
      sheetnames[sheetInfo.title] = true;
    }
  }
  if (group.pendingSheets != undefined) {
    for (var i=0; i<group.pendingSheets.length; ++i) {
      var sheet = group.pendingSheets.at(i);
      sheetnames[sheet.get('title')] = true;
    }
  }
  
  var filesArray = event.dataTransfer.files;

  var filteredArray = [];
  for (var i=0; i<filesArray.length; ++i) {
    var file = filesArray[i];
    if (file.name.endsWith('.pdf') && sheetnames[file.name] == undefined) {
      filteredArray.push(file);
    }
  }

  insertFilesInGroup(filteredArray, group);
}

var groupOrderKey = 0;
var groupTitleKey = 1;
var sheetNumberKey = 2;
var sheetNameKey   = 3;

function readCSV(file) {
  var reader = new FileReader();
  reader.onload = function (e) {
    var csv = e.target.result;
    var dicts = $.csv2Array(csv, {skip: 1}) || [];

    var newStructure = expectedStructure;

    // var sheetgroups = project.get('sheetgroups') || (new SheetGroupsCollection());
    var sheetgroupNames = [];
    for (var i=0; i<newStructure.length; ++i) {
      var group = newStructure[i];
      sheetgroupNames.push(group.name)
    }

    for (var i=0; i<dicts.length; ++i) {
      var row = dicts[i];
      var rowGroupName = row[groupTitleKey];
      var rowSheetNumber = row[sheetNumberKey];
      var rowTitle = row[sheetNameKey];

      var existingIndex = sheetgroupNames.indexOf(rowGroupName);
      if (existingIndex == -1) {
        var group = {
          name: rowGroupName,
          sheets: []
        };
        sheetgroupNames.push(rowGroupName);
        newStructure.push(group);
      }
      else {
        group = newStructure[existingIndex];
      }
      if (group.sheets === undefined) {
        group.sheets = [];
      }
      group.sheets.push({
        sheet_number: rowSheetNumber,
        title: rowTitle
      });
      newStructure
    }
    renderExpectedStructure();
  }
  reader.readAsText(file);
}

function handleCSVDrops (event, dropzone) {
  var group = $(dropzone).data('sheetgroup');
  
  var filesArray = event.dataTransfer.files;

  for (var i=0; i<filesArray.length; ++i) {
    var file = filesArray[i];
    if (file.name.endsWith('.csv')) {
      readCSV(file);
      break;
    }
  }
}

checkForLogin();
populateSheetGroups();
setupDragAndDrop(document.getElementById('csv-drop'), handleCSVDrops);
setupDragAndDrop(document.getElementById('pdf-drop'), handlePDFDrops);
</script>

</body>
</html>