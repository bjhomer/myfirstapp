<!DOCTYPE html>
<html>
<head>

<link type="text/css" rel="stylesheet" href="styles.css"

<!-- StackMob JS SDK Javascript Dependencies -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/json2-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/underscore-1.3.3-min.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/stackmob-js-0.2.1.js"></script>
<script type="text/javascript" src="http://static.stackmob.com/js/backbone-0.9.2-min.js"></script>
 
<!-- Initialize the StackMob JS SDK -->
<script type="text/javascript">
  StackMob.init({
    appName: "myfirstapp",
    clientSubdomain: "bjhomer",
    apiVersion: 0
  });
</script>

</head>
<body>

<div id="loginStatus"></div>

<ul id="sheetgroups-list" style="display:none">
  <li id="new-sheetgroup">
    <form onsubmit="createNewSheetGroup(); return false;">
      <input id='new-sheetgroup-name' type="text" placeholder="Add a new sheet group"/>
      <input type="submit" value="Add"/>
    </form>
  </li>
</ul>

<input type="button" onclick="uploadFiles()" value="Upload files" />




<li id="sheetgroup-template" style="display:none">
  <span class="sheetgroup-name"></span>
  <ul class="sheets-list"></ul>

  <div class="drag-target" style="display:none">Drop PDFs here to upload.
    <ul class="selected-files"></ul>
  </div>
</li>

<script type="text/javascript">

String.prototype.endsWith = function(suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

var SheetGroup = StackMob.Model.extend({ schemaName: 'sheetgroup' });
var SheetGroupsCollection = StackMob.Collection.extend({ model: SheetGroup });
var sheetgroups = new SheetGroupsCollection();

var Sheet = StackMob.Model.extend({ 
  schemaName: 'sheet'
});
var SheetCollection = StackMob.Collection.extend({model: Sheet});

var Project = StackMob.Model.extend({ schemaName: 'project' });

var loginStatus = document.getElementById('loginStatus');

var projectId = window.location.search.substring(1)
var project = new Project({ project_id: projectId });

function populateSheetGroups() {
  var loggedIn = StackMob.isLoggedIn();
  if (loggedIn == false) {
    console.debug("Can't list sheets while not logged in");
    return;
  }
  
  var sheetsList = document.getElementById('sheets-list')
  $(sheetsList).css('display', '');
  
  project.fetchExpanded(2, {
    success: function(model) {
      project = model;
      var groups = project.get('sheetgroups');
      if (groups == undefined) {
        showHasNoGroups();
        return;
      }
      for (var i=0; i<groups.length; ++i) {
        var model = new SheetGroup(groups[i]);
        appendSheetGroup(model);
      }
    },
    failure: function(model, response) {
      console.debug('failed to fetch project: ' + response);
    }
  });

}

function appendSheetGroup(group) {
  sheetgroups.add(group)

  var name = group.get('name');
  var $newElement = $('#sheetgroup-template').clone();
  $newElement.attr('id', 'sheetgroup-'+name);
  $newElement.find('.sheetgroup-name').text(name);
  $newElement.css('display', '')

  var $dragTarget = $newElement.find('.drag-target')
  $dragTarget.attr('id', 'drag-target-'+name);
  $dragTarget.css('display', '');
  $dragTarget.data('sheetgroup', group);
  setupDragAndDrop($dragTarget.get(0), name);
  $('#new-sheetgroup').before($newElement);
}


function createNewSheetGroup() {
  var nameField = document.getElementById('new-sheetgroup-name');
  var name = nameField.value;
  if (name.length == 0) {
    return;
  }
  var group = new SheetGroup({name: name});
  project.addRelationship('sheetgroups', [group], {
    success: function (group) {
      if (!group.toJSON) {
        group = new SheetGroup(group); 
      }
      appendSheetGroup(group);
      nameField.value = ""
    },
    error: function (model, response) {
      console.debug(response);
    }
  });
}

function showHasNoGroups() {
  $('#sheets-list').append("<li>There are no sheets in this project</li>");
}

function checkForLogin() {
  var loggedIn = StackMob.isLoggedIn();
  if (loggedIn == false) {
    $(loginStatus).html('<span>You are not logged in.<span> <a href="/login.html">Log in.</a>');
  }
  else {
    var username = StackMob.getLoggedInUser();
    $(loginStatus).text('Welcome, ' + username);
    $('#drag-target').css('display', '');
    $('#sheetgroups-list').css('display', '')
  }
}

function insertFilesInGroup(files, group) {
  var groupname = group.get('name');
  var dropzone = $('#drag-target-' + groupname);
  var listElement = $(dropzone).find('ul.selected-files')
  group.pendingSheets = new SheetCollection();

  $(listElement).html('');  
  for (var i=0; i<files.length; ++i) {
    var file = files[i];
    var filerow = $(listElement).append('<li>' + file.name + '</li>');

    (function (row) {
      sheetFromFile(file, function (sheet) {
        filerow.append('<span class="status" id="status-'+sheet.cid+'"></span>')
        group.pendingSheets.add(sheet);
      });
    })(filerow);
  }
}

function uploadFiles() {
  if (StackMob.isLoggedIn() == false) {
    return;
  }
  sheetgroups.each(function(group) {
    var sheets = group.pendingSheets;
    if (sheets != undefined) {
      sheets.each(function(sheet) {
          uploadSheetToGroup(sheet, group)
      });
    }
  });
}

function sheetFromFile(file, handler) {
  var reader = new FileReader();  
  var sheet = new Sheet();
  
  sheet.set({title: file.name});
  
  reader.onload = function (e) {
    var base64Content = e.target.result.substring(e.target.result.indexOf(',') + 1, e.target.result.length);
    var fileName = file.name;
    var fileType = file.type;
    
    sheet.setBinaryFile('sheet_data', fileName, fileType, base64Content);

    handler(sheet);
  };
  reader.readAsDataURL(file);
}

function uploadSheetToGroup(sheet, group) {

  $('#status-'+sheet.cid).html('uploading').addClass('inprogress')
  sheet.create({
    error: function (model, response) {
      console.debug('save failed:' + response);
    },
    success: function(model) {

      group.appendAndSave('sheets', [model.get('sheet_id')], {

        success: function(model) {
          console.debug("upload succeeded");
          $('#status-'+sheet.cid).html("done").removeClass('inprogress').addClass('done');
        },
        error: function(model, response) {
          console.debug("upload failed: " + response);
          $('#status-'+sheet.cid).html("error").removeClass('inprogress');
        }
        
      })
    }
  })
}

function setupDragAndDrop(dropzone) {
  
  dropzone.validatedrop = function(event) {
    var files = event.dataTransfer.files;
    var hasPDFs = false;

    for (var i=0; i<files.length; ++i) {
      var file = files[i];
      if (file.name.endsWith('.pdf')) {
        hasPDFs = true;
        break;
      }
    }
    return hasPDFs;
  }

  dropzone.ondragenter = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    $(dropzone).addClass('highlighted');
  }
  
  dropzone.ondragleave = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    $(dropzone).removeClass('highlighted');
  }
  
  dropzone.ondragover = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    event.dataTransfer.dropEffect = 'copy'
  }
  
  dropzone.ondrop = function(event) {
    event.stopPropagation();
    event.preventDefault();

    $(dropzone).removeClass('highlighted')

    var group = $(dropzone).data('sheetgroup');
    var filesArray = event.dataTransfer.files;

    var filteredArray = [];
    for (var i=0; i<filesArray.length; ++i) {
      var file = filesArray[i];
      if (file.name.endsWith('.pdf')) {
        filteredArray.push(file);
      }
    }

    insertFilesInGroup(filteredArray, group);
  }
  
  document.documentElement.ondragenter = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    event.dataTransfer.dropEffect = 'none';
  }
}


checkForLogin();
populateSheetGroups();
</script>

</body>
</html>